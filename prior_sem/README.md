# PyCosmo Power Spectrum Generator

This repository sets up a Python-based environment for computing cosmological power spectra using a custom wrapper built on PyCosmo. The build is managed using make.

## Project structure
```
PyCosmo_Simgadget/
├── README.md
├── PyCosmo_Power_Spectrum/             # Contains code for generating power spectra using PyCosmo
    ├── Functions/
    ├── initial_conditions/                     # Stores .csv files of the initial conditions generated by N-GenIC
    ├── outputted_power_spectrum/               # Power spectrum files generated by PyCosmo
    ├── tests/                                  # Unit and integration tests
        ├── test_k_values.py                        # Tests for errors in the computation of k values
        ├── test_power_spectrum_computation.py      # Tests for errors in PyCosmo power spectra generation
        ├── test_power_spectrum_plot.py             # Tests the generation of the power spectra plots       
        ├── test_read_param_file.py                 # Ensures that the parameter files are read properly
    ├── parameter_files/                            # Input parameter files read by PyCosmo
    ├── pycosmo_plotting/                      # Plot generation code
        ├── animate_density.py                      # Visualisation of structure evolution
        ├── initial_conditions_comparison.py        # Generates histograms of initial conditions
        ├── initial_conditions_comparison.py        # Generates histograms of final conditions
        ├── plot_input_spectrum.py                  # Generates P(k) & dimensionless P(k) plots
        ├── pycosmohub.mplstyle                     # Standard PyCosmo matplotlib style
        ├── generated_plots/                        # Outputted plots
        ├── structure_formation_data/
             ├── ngenic_data/                           # Structure evolution snapshots with no PyCosmo input
             ├── pycosmo_data/                          # Structure evolution snapshots with PyCosmo input
    ├── power_spectrum_generation/                  # Main power spectrum generation code
        ├── custom_power_spectrum.py                    # Coordinates data passing from parameter file to pycosmo class
        ├── power_spectrum_class.py                     # Contains custom class to automate power spectrum generation    
├── ngenic                              # Contains code for generating initial conditions using N-GenIC
    ├── (See the N-GenIC documentation)


```
## Setup Instructions

### 1. Clone the repository

```bash
git clone https://github.com/your-repo/power-spectrum-generator.git
cd power-spectrum-generator
```

### 2. Set Up PyCosmo 

#### 2.1 Set-up the PyCosmo Environment 

This is required to generate the Power Spectrum files which will be used as inputs in N-GenIC:

```bash
cd PyCosmo_Power_Spectrum
source setup_pycosmo.sh
```

This will:

* Activate the Python virtual environment
* Set `LD_LIBRARY_PATH` correctly

#### 2.2 Load System Dependencies Required for PyCosmo

This project requires two different versions of GSL, thus it is important to load the system dependencies within separate virtual environments; one for N-GenIC and one for PyCosmo.

Requirements for running the PyCosmo code include:

* Make
* System Package Manager:
    * `apt` for Linux/WSL
    * `brew` for macOS
* GSL (2.8 for PyCosmo, 2.7.1 for N-GenIC)
* GCC (12.2.0)
* OpenMPI (4.1.6)
* Python (3.9)
* TeX Live
* virtualenv

On clusters, these can be loaded as modules. For example, on the ETH Euler Cluster:

```bash
module load stack/2024-06
module load gcc/12.2.0
module load gsl/2.7.1
module load openmpi/4.1.6
module load python/3.9
module load texlive
```

#### 2.2 Run the PyCosmo Makefile

```bash
make
```

This will:
* Load requirements for PyCosmo to run 

### 3. Set Up N-GenIC

#### 3.1 Setup the N-GenIC Virtual Environment:
This is required to generate the Power Spectrum files which will be used as inputs in N-GenIC:

```bash
cd ngenic
dos2unix setup_ngenic.sh
source setup_ngenic.sh
```

This will:

* Activate the N-GenIC virtual environment
* Set `LD_LIBRARY_PATH` correctly

#### 3.2 Load System Dependencies Required for N-GenIC

Requirements for the N-GenIC code include:

* Make
* System Package Manager:
    * `apt` for Linux/WSL
    * `brew` for macOS
* GSL (2.7.1 for N-GenIC)
* GCC (12.2.0)
* OpenMPI (4.1.6)

On clusters, these can be loaded as modules. For example, on the ETH Euler Cluster:

```bash
module load stack/2024-06
module load gcc/12.2.0
module load openmpi/4.1.6
module load gsl/2.7.1
```

#### 3.3 Install the correct version of FFTW:

N-GenIC requires an older version of the FFTW code, namely version 2. This version can be installed from their website. To install the library at a specific path path, one can specify this with the prefix option. Furthermore, the options shared and mpi have to be enabled. 

```bash
cd ngenic
wget https://www.fftw.org/fftw-2.1.5.tar.gz
tar -xvzf fftw-2.1.5.tar.gz
cd fftw-2.1.5
./configure --prefix=<path> --enable-shared --enable-mpi
make
make install
```

Ensure to edit <path> according to where the library should be installed. For instance, to install it locally instead of a system wide path, one cat set `--prefix=$(pwd)/../local/fftw-2.1.5`

#### 3.4 Compile N-GenIC

To make sure that the FFTW library is found, one needs to specify in the Makefile inside the N-GenIC folder, the following two options, which specify the location of the previously installed FFTW library.

```bash
FFTW_INCL= -I path/include
FFTW_LIBS= -L path/lib
```

Then the source code can be compiled:
```bash
cd ngenic
make
```

This will:

* Load the appropriate GSL 2.7.1 library
* Set <LD_LIBRARY_PATH> for N-GenIC compatibility

## 4. Usage

### 4.1 Generating a Power Spectrum with PyCosmo

#### 4.1.1 Testing PyCosmo Power Spectrum Generation

Run unit tests:
```bash
make test
```

Run full test suite (clears cache, reinstalls system deps):
```bash
make test_full
```

#### 4.1.2 Generating a Power Spectrum

To run the main script with a specific parameter file:
```bash
make run PARAM=path/to/your_param_file.param
```

For example:
```bash
make run PARAM=PyCosmo_Power_Spectrum/parameter_files/pycosmo_input_32.param
```

This executes:
```bash
python -m power_spectrum_generation.custom_power_spectrum parameter_files/pycosmo_input_32.param
```
This will generate a power spectrum for 32^3 particles in a box with a side length of 50000 Mpc. It uses the parameter file `pycosmo_input_32.param` which is stored in the parameterfiles folder and will save the generated power spectrum in the folder PyCosmo_Power_Spectrum/outputted_power_spectrum/. For both PyCosmo and N-GenIC, simulations with 16, 32, 64, 128, 256, 512, or 1024 particles can be chosen from.

#### 4.1.3 Cleaning the PyCosmo Environment 

Remove build artifacts, .pyc files, virtual environment:
```bash
make clean
```

To clear the sympy2c cache
```bash
make clear_cache
```

### 4.2 Creating initial conditions with N-GenIC

Once an initial power spectrum has been generated with PyCosmo, initial conditions can be generated with N-GenIC. 

This is executed using the following target:
```bash
make run ID=PARTICLES
```
where PARTICLES is the number of particles for which the initial conditions are to be generated.

Running this command generates initial conditions for (a) a simulation which takes a power spectrum generated by PyCosmo as input and (b) a simulation in which N-GenIC generates the Power Spectrum without an input from the user. 

By default, two initial condition files will be generated; The binary file lsf_32 which is compatible with GADGET and lsf_32.csv which is a readable .csv file containing the particle positions and velocities. Once generated, these files can be found in `PyCosmo_Power_Spectrum/initial_conditions`.

## 5. Generating comparison plots

To generate histograms comparing the two 

## 6. Switching Between Environments

When you run:
```bash
source PyCosmo/setup_pycosmo.sh
```

You: 
* Activate pycosmo_env
* Set LD_LIBRARY_PATH, PATH, etc. for PyCosmo

When you're done and want to switch:
```bash
deactivate
source ngenic/setup_ngenic.sh
```

You:
* Deactivate pycosmo_env
* Activate ngenic_env
* Replace GSL/FFTW environment variables for N-GenIC
  
Don't activate both environments at once. Always deactivate first.